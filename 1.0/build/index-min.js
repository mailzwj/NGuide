/*! NGuide - v1.0 - 2013-09-19 8:36:37 AM
* Copyright (c) 2013 Letao; Licensed  */
KISSY.config({packages:[{name:"gallery/offline/1.1/index",path:"http://a.tbcdn.cn/s/kissy/",charset:"utf-8"}]}),KISSY.add("gallery/NGuide/1.0/index",function(a,b,c,d,e){function f(b){var c=this;f.superclass.constructor.call(c,b),c.offline=new e,c.tpl=f.TEMPLATE.overlay,c.id=b.id||"ng-index",c.arrowSize=b.arrowSize||15,c.auto=b.auto,c.trigger=a.all(b.trigger),c.steps=b.steps||[],c.stateId="ks-state-step-"+c.id,c.ng=a.one(".NG-Guide"),c.ng||(c.ng=a.one(a.DOM.create('<div class="NG-Guide"></div>')),a.one("body").append(c.ng)),c.defaultWidth=c.ng.width(),c.curStep=1,c.animDist=80,c.topDist=100,c.auto?c.init():c._bindEvent()}return b.all,f.TEMPLATE={overlay:'{{#if data}}{{#data}}<div class="NG-Content clearfix"><span class="NG-stepNumber">{{step}}</span><div class="NG-body">{{#if title}}<h2 class="NG-Guide-title">{{title}}</h2>{{/if}}{{#if content}}<div class="NG-Guide-content">{{content}}</div>{{/if}}</div><div class="NG-Guide-Actions">{{{actions}}}</div></div><div class="NG-Arrow"><span class="border-arrow border-arrow-down"></span><span class="border-arrow border-arrow-up"></span></div>{{/data}}{{/if}}<a class="NG-Guide-Close" href="javascript:void(0);" title="\u5173\u95ed"></a>',prev:'<input type="button" class="NG-btn NG-btn-prev" value="\u4e0a\u4e00\u4e2a">',next:'<input type="button" class="NG-btn NG-btn-next" value="\u4e0b\u4e00\u4e2a">',done:'<input type="button" class="NG-btn NG-btn-done" value="\u5b8c\u6210">',skip:'<input type="button" class="NG-btn NG-btn-skip" value="\u8df3\u8fc7">'},a.extend(f,c,{_bindEvent:function(){var a=this;a.trigger.on("click",function(b){a.init(),b.preventDefault()})},_setItem:function(a){var b=this;b.offline.setItem(b.stateId,b.id+":"+a)},_delegateAction:function(){var a=this;a.ng.delegate("click",".NG-btn-prev",function(b){a.gotoStep(--a.curStep),a._setItem(a.curStep),b.preventDefault()}),a.ng.delegate("click",".NG-btn-next",function(b){a.gotoStep(++a.curStep),a._setItem(a.curStep),b.preventDefault()}),a.ng.delegate("click",".NG-btn-skip",function(b){a._setItem("off"),a.destory(),b.preventDefault()}),a.ng.delegate("click",".NG-btn-done",function(b){a._setItem("off"),a.destory(),b.preventDefault()}),a.ng.delegate("click",".NG-Guide-Close",function(b){a.hide(),b.preventDefault()})},_getPosition:function(b){var c=this,d=c.steps[b-1],e=a.one(d.target),f=e.offset(),g={width:e.outerWidth(),height:e.outerHeight()},h={width:c.ng.outerWidth(),height:c.ng.outerHeight()},i={left:0,top:0};switch(d.offsetX=d.offsetX?d.offsetX:0,d.offsetY=d.offsetY?d.offsetY:0,d.placement){case"right":i.left=f.left+g.width+d.offsetX+c.arrowSize,i.top=f.top+d.offsetY;break;case"top":i.left=f.left+d.offsetX,i.top=f.top-h.height-d.offsetY-c.arrowSize;break;case"bottom":i.left=f.left+d.offsetX,i.top=f.top+g.height+d.offsetY+c.arrowSize;break;default:i.left=f.left-h.width-c.arrowSize-d.offsetX,i.top=f.top+d.offsetY}return i},_setArrowPosition:function(a){var b=this,c=b.steps[a-1],d=b.ng.one(".NG-Arrow");if(c.arrowOffset)switch(c.placement){case"right":d.css("top",c.arrowOffset);break;case"top":d.css("left",c.arrowOffset);break;case"bottom":d.css("left",c.arrowOffset);break;default:d.css("top",c.arrowOffset)}},_setNgWidth:function(a){var b=this,c=b.steps[a-1],d=/(^|\s+)NG\-Guide\-\w+(\s|$)/g,e=b.ng.attr("class");c.placement=c.placement?c.placement:"left",c.width?b.ng.css("width",c.width):b.ng.css("width",b.defaultWidth),e.match(d)?b.ng.attr("class",e.replace(d,"$1NG-Guide-"+c.placement+"$2")):b.ng.addClass("NG-Guide-"+c.placement)},_scrollWindow:function(b,c,d){var e=this,f=a.one(window),g=f.scrollTop(),h={width:f.outerWidth(),height:f.outerHeight()},i={width:e.ng.outerWidth(),height:e.ng.outerHeight()};b.top-e.topDist<0?f.animate({scrollTop:b.top-e.topDist>0?b.top:0},.5,"easeOut",function(){d&&d()}):b.top+i.height+e.topDist>g+h.height?f.animate({scrollTop:b.top+i.height+e.topDist-h.height},.5,"easeOut",function(){d&&d()}):d&&d()},_moveToTarget:function(a,b){var c=this,d=c.steps[b-1],e={left:a.left,top:a.top};switch(d.placement){case"right":e.left=a.left+c.animDist;break;case"top":e.top=a.top-c.animDist;break;case"bottom":e.top=a.top+c.animDist/2;break;default:e.left=a.left-c.animDist/2}c.ng.css({opacity:0,top:e.top,left:e.left}),a.opacity=1,c._scrollWindow(a,b,function(){c.ng.animate(a,.5,"easeOut",function(){})})},init:function(){var a=this;if(a.steps.length<=0)return a.destory(),void 0;var b=a.offline.getItem(a.stateId);if(b){var c=b.split(":")[1];if(isNaN(parseInt(c)))return a.destory(),void 0;a.curStep=parseInt(c),a.gotoStep(a.curStep)}else a.gotoStep(a.curStep),a._setItem(a.curStep);a._delegateAction()},gotoStep:function(b){var c=this,e=c.steps.length;if(1>e||b>e)return a.log("Something is wrong."),!1;var g=f.TEMPLATE.prev+f.TEMPLATE.next+f.TEMPLATE.skip,h={data:c.steps[b-1]};1===b?g=f.TEMPLATE.next+f.TEMPLATE.skip:b===e&&(g=f.TEMPLATE.prev+f.TEMPLATE.done),1===e&&(g=f.TEMPLATE.done),h.data.actions=g,h.data.step=b;var i=new d(c.tpl).render(h);c.ng.html(i),c._setNgWidth(b),c._setArrowPosition(b);var j=c._getPosition(b);c._moveToTarget(j,b)},destory:function(){var a=this;a.ng.remove()},hide:function(){var a=this;a.ng.hide()},reset:function(){var a=this;a.offline.removeItem(a.stateId)}},{ATTRS:{}}),f},{requires:["node","base","xtemplate","gallery/offline/1.1/index"]});